#!/usr/bin/env node
var fs = require('fs'),
    smoosh = require('smoosh'),
    request = require('request');
    require('colors');

!function () {

  var halt = false;

  var defaultLibs = [
    "qwery",
    "bean",
    "bonzo",
    "klass",
    "reqwest",
    "emile",
    "script",
    "underscore"
  ];

  var copyright = '/*!' +
    '  * Ender.js: a small, powerful JavaScript library composed of application agnostic submodules' +
    '  * copyright Dustin Diaz & Jacob Thornton 2011 (@ded @fat)' +
    '  * https://github.com/ded/Ender.js' +
    '  * License MIT' +
    '  */';

  var enderWrapper;
  request({uri: 'https://github.com/ded/Ender.js/raw/master/src/ender.js'},
    function (error, response, body) {
      enderWrapper = body;
      listInstalled();
    }
  );

  var packages;
  function listInstalled() {
    exec('npm ls installed', function (error, out, stderr) {
      if (!error) {
        var re = /(?:^|\n)([\w\-]+)@[\d\.]+(?:\s)/gi;
        packages = out.match(re).map(function (p) {
          return p.replace(/\n|(@.+)/g, '');
        });
        processArgs();
      }
    });
  }

  var args = process.argv.slice(2),
      flags,
      outDir = './',
      totalLibs = 0;

  if (args[0][0] == '-') {
    flags = args[0].replace(/^\-/, '').split('');
  } else {
    flags = [args[0]];
  }

  function processArgs() {
    flags.forEach(function(flag) {
      switch (flag) {
        case 'b':
          var input = args[1] ? args[1].split(',') : defaultLibs;
          totalLibs = input.length;
          console.log(('Building the Dragon Army with '.cyan) + ((input.length).toString().red) + (' modules'.green));

          input.forEach(function (lib) {
            var installed = false, i;

            for (i = 0; i < packages.length; i++) {
              if (packages[i] == lib) {
                installed = true;
                console.log('module ' + lib + ' already installed âœ“');
                addToBundle(lib);
                break;
              }
            }

            if (!installed) {
              console.log(('installing ' + lib + '...').cyan);
              var cmd = 'npm install ' + lib;
              var retry = false;
              function command(input) {
                if (retry) {
                  console.log('could not install ' + lib + '. trying sudo');
                }
                exec(input, function (error, out) {
                  if (!error) {
                    console.log('successful installation of ' + lib);
                    addToBundle(lib);
                  } else {
                    retry = true;
                    command('sudo ' + cmd);
                  }
                });
              }
              command(cmd);
            }
          });

          break;
      }
    });
  }

  var outputFileBuffer = '';
  function addToBundle(lib) {

    exec('npm view ' + lib, function (error, out) {
      if (!error) {
        var info = eval('(' + out + ')');

        if (!info.ender) {
          console.log('Sorry. ' + p + ' is not a published Ender package on NPM');
        }

        var url = info.repository.url.replace(/^(git:|http:)/, 'https:').replace(/\.git$/, '') + '/raw/master/';
        // https://github.com/ded/klass/raw/master/src/ender.js

        // console.log(info);
        var ender = url + info.ender;

        request({uri: ender}, function (error, response, body) {
          if (!error && response.statusCode == 200) {
            console.log('Ender Bridge file found!'.cyan);
            console.log(body);
          } else {
            console.log('an Ender bridge file was not found at the repository URL'.red);
          }
        });

      } else {
        console.log(('Ender installation error for ' + lib + ' module').red);
        console.log(error);
      }
    });
  }


  function outputAndSmoosh() {
    if (--totalLibs > 0) {
      return;
    }
    fs.writeFile(outDir + 'ender.js', out, 'utf8', function () {
      smoosh.config({
        "quiet": true,
        "JAVASCRIPT": {
          "DIST_DIR": outDir,
          "ender": [
            './src/copyright.js',
            outDir + 'ender.js'
          ]
        }
      }).build();
    });
  }


}();
